<UserControl x:Class="LorModEditor.Views.CardEditorView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:prism="http://prismlibrary.com/"
             xmlns:wrappers="clr-namespace:LorModEditor.Core.Wrappers;assembly=LorModEditor.Core"
             xmlns:viewModels="clr-namespace:LorModEditor.ViewModels"
             xmlns:core1="clr-namespace:LorModEditor.Core;assembly=LorModEditor.Core"
             xmlns:components="clr-namespace:LorModEditor.Views.Components"
             mc:Ignorable="d"
             prism:ViewModelLocator.AutoWireViewModel="True"
             d:DataContext="{d:DesignInstance Type= viewModels:CardEditorViewModel, IsDesignTimeCreatable=False}"
             d:DesignHeight="700" d:DesignWidth="1000">

    <UserControl.Resources>
        <Style x:Key="EllipsisCellStyle" TargetType="TextBlock">
            <Setter Property="TextTrimming" Value="CharacterEllipsis" />
            <Setter Property="ToolTip" Value="{Binding Text, RelativeSource={RelativeSource Self}}" />
            <Setter Property="VerticalAlignment" Value="Center" />
            <Setter Property="Padding" Value="5,2" />
        </Style>
    </UserControl.Resources>
    <UserControl.InputBindings>
        <!-- Ctrl + N -> æ–°å»ºå¡ç‰Œ -->
        <KeyBinding Key="N" Modifiers="Control" Command="{Binding CreateCommand}"/>
        
        <!-- Delete é”® -> åˆ é™¤å¡ç‰Œ (æ³¨æ„ï¼šæœ‰äº›è¾“å…¥æ¡†å¯èƒ½ä¼šæŠ¢å  Delete é”®ï¼Œéœ€æ³¨æ„ç„¦ç‚¹) -->
        <!-- é€šå¸¸ä¸ºäº†å®‰å…¨ï¼Œåˆ é™¤æ“ä½œå»ºè®®ä¿ç•™ Ctrl+Delete æˆ–è€…åªç”¨æŒ‰é’® -->
        <KeyBinding Key="Delete" Modifiers="Control" Command="{Binding DeleteCommand}"/>
    </UserControl.InputBindings>
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="280" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- =================================================================== -->
        <!-- [å·¦ä¸Š] å·¥å…·æ  -->
        <!-- =================================================================== -->
        <Border Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2"
                Background="#F5F5F5" BorderBrush="#DDDDDD" BorderThickness="0,0,0,1" Padding="10,6">
            <StackPanel Orientation="Horizontal">
                <!-- æ–°å»ºæŒ‰é’®ï¼šç»‘å®š ViewModel çš„ CreateCommand -->
                <Button Content="âž• æ–°å»ºå¡ç‰Œ"
                        Command="{Binding CreateCommand}"
                        IsEnabled="{Binding Manager.CardRepo.HasData}"
                        Padding="12,5" Margin="0,0,10,0" FontWeight="Bold">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="ToolTip" Value="æ–°å»ºä¸€å¼ æˆ˜æ–—ä¹¦é¡µ" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Manager.CardRepo.HasData}" Value="False">
                                    <Setter Property="ToolTip" Value="[ä¸å¯ç”¨] æœªåŠ è½½æœ‰æ•ˆçš„ Mod æ•°æ®æ–‡ä»¶" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
                <Button Content="ðŸ“„ å¤åˆ¶å¡ç‰Œ"
                        Command="{Binding DuplicateCommand}"
                        Padding="12,5" Margin="0,0,10,0"
                        Background="#FFF8DC" BorderBrush="#FFD700" FontWeight="Bold"
                        ToolTip="å¤åˆ¶å½“å‰é€‰ä¸­çš„å¡ç‰Œ (åŒ…æ‹¬åŽŸç‰ˆå¡)" />
                <!-- åˆ é™¤æŒ‰é’®ï¼šç»‘å®š DeleteCommand -->
                <Button Content="ðŸ—‘ï¸ åˆ é™¤å¡ç‰Œ"
                        Command="{Binding DeleteCommand}"
                        Padding="12,5" Background="#FFE6E6" BorderBrush="#FFCCCC" />

            </StackPanel>
        </Border>

        <!-- =================================================================== -->
        <!-- [å·¦ä¸‹] å¡ç‰Œåˆ—è¡¨ -->
        <!-- =================================================================== -->
        <DockPanel Grid.Row="1" Grid.Column="0">
            <TextBox DockPanel.Dock="Top"
                     x:Name="SearchBox"
                     TextChanged="SearchBox_TextChanged"
                     Margin="5" Padding="5"
                     BorderBrush="#CCC" BorderThickness="1"
                     ToolTip="è¾“å…¥ ID æˆ– åç§° è¿›è¡Œæœç´¢..." />

            <ListBox x:Name="CardListBox"
                     VirtualizingStackPanel.IsVirtualizing="True"
                     VirtualizingStackPanel.VirtualizationMode="Recycling"
                     ItemsSource="{Binding Manager.CardRepo.Items}"
                     SelectedItem="{Binding SelectedCard}"
                     DisplayMemberPath="DisplayName"
                     SelectionChanged="CardListBox_SelectionChanged"
                     BorderThickness="0,0,1,0" BorderBrush="#DDDDDD" />
        </DockPanel>

        <!-- =================================================================== -->
        <!-- [å³ä¸‹] ç¼–è¾‘åŒºåŸŸ -->
        <!-- =================================================================== -->
        <ScrollViewer Grid.Row="1" Grid.Column="1"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled">

            <!-- DataContext åˆ‡æ¢ä¸º SelectedCard (UnifiedCard) -->
            <StackPanel x:Name="EditPanel" Margin="20" DataContext="{Binding SelectedCard}">

                <StackPanel.Style>
                    <Style TargetType="StackPanel">
                        <!-- é»˜è®¤å¯è§ -->
                        <Setter Property="Visibility" Value="Visible" />

                        <Style.Triggers>
                            <!-- 1. å¦‚æžœæ²¡æœ‰é€‰ä¸­å¡ç‰Œ (DataContext == null)ï¼Œéšè—é¢æ¿ -->
                            <DataTrigger Binding="{Binding}" Value="{x:Null}">
                                <Setter Property="Visibility" Value="Hidden" />
                            </DataTrigger>

                            <!-- 2. å¦‚æžœæ˜¯åŽŸç‰ˆæ•°æ®ï¼Œç¦ç”¨ç¼–è¾‘ -->
                            <DataTrigger Binding="{Binding IsVanilla}" Value="True">
                                <Setter Property="IsEnabled" Value="False" />
                                <Setter Property="Opacity" Value="0.7" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </StackPanel.Style>

                <TextBlock Text="å¡ç‰Œå±žæ€§ç¼–è¾‘" FontSize="22" FontWeight="Bold" Margin="0,0,0,15" Foreground="#333" />

                <!-- 1. å¡å›¾é¢„è§ˆåŒº -->
                <Expander Header="ðŸ–¼ï¸ å¡å›¾é¢„è§ˆ">
                    <StackPanel Margin="10">

                        <!-- ä¸€è¡Œä»£ç æžå®šï¼ -->
                        <components:ImageSelector
                            LabelText="Card Artwork:"
                            SelectedImageName="{Binding ArtworkName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            ImageList="{Binding DataContext.Manager.Artworks, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            Manager="{Binding DataContext.Manager, RelativeSource={RelativeSource AncestorType=UserControl}}"

                            PreviewWidth="205" PreviewHeight="155" />

                    </StackPanel>
                </Expander>

                <!-- 2. åŸºç¡€ä¿¡æ¯åŒº -->
                <Expander Header="ðŸ“ åŸºç¡€ä¿¡æ¯ (Basic Info)" IsExpanded="True" Margin="0,0,0,15" BorderBrush="#DDD"
                          BorderThickness="1">
                    <StackPanel Margin="10">
                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="100" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                <TextBlock Text="ID:" FontWeight="Bold" />
                                <TextBox Text="{Binding Id, UpdateSourceTrigger=PropertyChanged}" />
                            </StackPanel>
                            <StackPanel Grid.Column="1">
                                <TextBlock Text="Name (åç§°):" FontWeight="Bold" />
                                <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}" />
                            </StackPanel>
                        </Grid>

                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="10" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="10" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Cost (è´¹ç”¨):" />
                                <TextBox Text="{Binding Cost, UpdateSourceTrigger=PropertyChanged}" />
                            </StackPanel>
                            <StackPanel Grid.Column="2">
                                <TextBlock Text="Range (è·ç¦»):" />
                                <ComboBox ItemsSource="{x:Static core1:GlobalValues.Ranges}"
                                          SelectedItem="{Binding Range, UpdateSourceTrigger=PropertyChanged}" />
                            </StackPanel>
                            <StackPanel Grid.Column="4">
                                <TextBlock Text="Rarity (ç¨€æœ‰åº¦):" />
                                <ComboBox ItemsSource="{x:Static core1:GlobalValues.Rarities}"
                                          SelectedItem="{Binding Rarity, UpdateSourceTrigger=PropertyChanged}" />
                            </StackPanel>
                        </Grid>

                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="10" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Chapter (ç« èŠ‚ç­‰çº§):" />
                                <TextBox Text="{Binding Chapter, UpdateSourceTrigger=PropertyChanged}" />
                            </StackPanel>
                            <StackPanel Grid.Column="2">
                                <TextBlock Text="Priority (AIä¼˜å…ˆçº§):" />
                                <TextBox Text="{Binding Priority, UpdateSourceTrigger=PropertyChanged}" />
                            </StackPanel>
                        </Grid>

                        <!-- ä¸»è„šæœ¬ (Script) ç»‘å®š -->
                        <TextBlock Text="Script (ä¸»è„šæœ¬):" Margin="0,5,0,0" FontWeight="Bold" />
                        <ComboBox IsEditable="True"
                                  Text="{Binding Script, UpdateSourceTrigger=PropertyChanged}"
                                  ItemsSource="{Binding DataContext.Manager.ScriptScanner.CardScripts, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                  ToolTip="å¯è¾“å…¥è‡ªå®šä¹‰è„šæœ¬ï¼Œæˆ–ä»Ž DLL ä¸­é€‰æ‹©" />

                        <!-- ç‰¹æ€§ Options -->
                        <GroupBox Header="ðŸ·ï¸ å¡ç‰Œç‰¹æ€§ (Options)" Margin="0,10,0,0">
                            <StackPanel Margin="5">
                                <DockPanel LastChildFill="True" Margin="0,0,0,5">
                                    <!-- æ·»åŠ ç‰¹æ€§æŒ‰é’®ï¼šç»‘å®š AddOptionCommand -->
                                    <Button DockPanel.Dock="Right" Content="âž• æ·»åŠ "
                                            Command="{Binding DataContext.AddOptionCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            Padding="10,2" Margin="5,0,0,0" />

                                    <!-- ä¸‹æ‹‰æ¡†ï¼šç»‘å®š SelectedOptionToAdd (ViewModel å±žæ€§) -->
                                    <ComboBox ItemsSource="{x:Static core1:GlobalValues.CardOptions}"
                                              SelectedItem="{Binding DataContext.SelectedOptionToAdd, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                                </DockPanel>

                                <!-- ç‰¹æ€§åˆ—è¡¨ -->
                                <ListBox ItemsSource="{Binding OptionList}" Height="80" BorderBrush="#CCC"
                                         BorderThickness="1">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <DockPanel>
                                                <!-- åˆ é™¤ç‰¹æ€§æŒ‰é’®ï¼šç»‘å®š RemoveOptionCommandï¼Œä¼ é€’å½“å‰å­—ç¬¦ä¸²ä½œä¸ºå‚æ•° -->
                                                <Button Content="âŒ" DockPanel.Dock="Right"
                                                        Command="{Binding DataContext.RemoveOptionCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"
                                                        Padding="5,0" Margin="5,0,0,0" />
                                                <TextBlock Text="{Binding}" VerticalAlignment="Center" />
                                            </DockPanel>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </StackPanel>
                        </GroupBox>
                        <!-- æ”¾åœ¨ Option GroupBox ä¸‹é¢ -->
                        <GroupBox Header="ðŸ”‘ å…³é”®è¯ (Keywords)" Margin="0,10,0,0">
                            <StackPanel Margin="5">
                                <!-- æ·»åŠ æ  -->
                                <DockPanel LastChildFill="True" Margin="0,0,0,5">
                                    <Button DockPanel.Dock="Right" Content="âž• æ·»åŠ "
                                            Command="{Binding DataContext.AddKeywordCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            Padding="10,2" Margin="5,0,0,0" />

                                    <!-- è¾“å…¥æ¡† -->
                                    <TextBox
                                        Text="{Binding DataContext.KeywordToAdd, RelativeSource={RelativeSource AncestorType=UserControl}, UpdateSourceTrigger=PropertyChanged}"
                                        ToolTip="è¾“å…¥å…³é”®è¯ (å¦‚: Smoke, Vibration)" />
                                </DockPanel>

                                <!-- åˆ—è¡¨ -->
                                <ListBox ItemsSource="{Binding Keywords}" Height="80" BorderBrush="#CCC"
                                         BorderThickness="1">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <DockPanel>
                                                <Button Content="âŒ" DockPanel.Dock="Right"
                                                        Command="{Binding DataContext.RemoveKeywordCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"
                                                        Padding="5,0" Margin="5,0,0,0" />
                                                <TextBlock Text="{Binding}" VerticalAlignment="Center" />
                                            </DockPanel>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </Expander>

                <!-- 3. éª°å­é…ç½®åŒº -->
                <Expander Header="ðŸŽ² éª°å­é…ç½® (Behaviours)" IsExpanded="True" Margin="0,0,0,15" BorderBrush="#DDD"
                          BorderThickness="1">
                    <StackPanel Margin="10">
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <!-- éª°å­å¢žåˆ å‘½ä»¤ -->
                            <Button Content="âž• æ·»åŠ éª°å­"
                                    Command="{Binding DataContext.AddDiceCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                    Width="90" Margin="0,0,10,0" />
                            <Button Content="âž– åˆ é™¤é€‰ä¸­"
                                    Command="{Binding DataContext.RemoveDiceCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                    Width="90" />
                        </StackPanel>

                        <!-- éª°å­è¡¨æ ¼ (ç»‘å®š ViewModel.SelectedDice) -->
                        <DataGrid x:Name="DiceGrid"
                                  ItemsSource="{Binding Behaviours}"
                                  SelectedItem="{Binding DataContext.SelectedDice, RelativeSource={RelativeSource AncestorType=UserControl}}"

                                  AutoGenerateColumns="False"
                                  CanUserAddRows="False"
                                  CanUserSortColumns="False"
                                  CanUserReorderColumns="False"
                                  MinHeight="200"
                                  BorderThickness="1" BorderBrush="#CCC"
                                  HorizontalScrollBarVisibility="Auto"
                                  VerticalScrollBarVisibility="Auto">

                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Min"
                                                    Binding="{Binding Min, UpdateSourceTrigger=PropertyChanged}"
                                                    Width="50" />
                                <DataGridTextColumn Header="Max"
                                                    Binding="{Binding Dice, UpdateSourceTrigger=PropertyChanged}"
                                                    Width="50" />

                                <DataGridTemplateColumn Header="Type" Width="80">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate DataType="wrappers:UnifiedBehaviour">
                                            <TextBlock Text="{Binding Type}" VerticalAlignment="Center" Padding="5,0" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate DataType="wrappers:UnifiedBehaviour">
                                            <ComboBox ItemsSource="{x:Static core1:GlobalValues.DiceTypes}"
                                                      SelectedItem="{Binding Type, UpdateSourceTrigger=PropertyChanged}" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTemplateColumn Header="Detail" Width="110">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate DataType="wrappers:UnifiedBehaviour">
                                            <TextBlock Text="{Binding Detail}" VerticalAlignment="Center" Padding="5,0" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate DataType="wrappers:UnifiedBehaviour">
                                            <ComboBox ItemsSource="{x:Static core1:GlobalValues.DiceDetails}"
                                                      SelectedItem="{Binding Detail, UpdateSourceTrigger=PropertyChanged}" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTemplateColumn Header="Motion" Width="70">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate DataType="wrappers:UnifiedBehaviour">
                                            <TextBlock Text="{Binding Motion}" VerticalAlignment="Center" Padding="5,0" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate DataType="wrappers:UnifiedBehaviour">
                                            <ComboBox ItemsSource="{x:Static core1:GlobalValues.DiceMotions}"
                                                      SelectedItem="{Binding Motion, UpdateSourceTrigger=PropertyChanged}" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTemplateColumn Header="Script (è„šæœ¬)" Width="200">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate DataType="wrappers:UnifiedBehaviour">
                                            <TextBlock Text="{Binding Script}" VerticalAlignment="Center" Padding="5,0" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate DataType="wrappers:UnifiedBehaviour">
                                            <!-- ç»‘å®š DiceScripts -->
                                            <ComboBox IsEditable="True"
                                                      Text="{Binding Script, UpdateSourceTrigger=PropertyChanged}"
                                                      ItemsSource="{Binding DataContext.Manager.ScriptScanner.DiceScripts, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTextColumn Header="VFX (ç‰¹æ•ˆ)"
                                                    Binding="{Binding EffectRes, UpdateSourceTrigger=PropertyChanged}"
                                                    Width="Auto" MinWidth="120"
                                                    ElementStyle="{StaticResource EllipsisCellStyle}" />
                                <DataGridTextColumn Header="Desc (å¤‡æ³¨)"
                                                    Binding="{Binding Desc, UpdateSourceTrigger=PropertyChanged}"
                                                    Width="Auto" MinWidth="150"
                                                    ElementStyle="{StaticResource EllipsisCellStyle}" />
                            </DataGrid.Columns>
                        </DataGrid>
                    </StackPanel>
                </Expander>

                <TextBlock Height="60" />
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>