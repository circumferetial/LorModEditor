<UserControl x:Class="LorModEditor.Views.PassiveEditorView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:prism="http://prismlibrary.com/"
             xmlns:core="clr-namespace:LorModEditor.Core;assembly=LorModEditor.Core"
             xmlns:viewModels="clr-namespace:LorModEditor.ViewModels"
             mc:Ignorable="d"
             prism:ViewModelLocator.AutoWireViewModel="True"
             d:DataContext="{d:DesignInstance Type=viewModels:PassiveEditorViewModel, IsDesignTimeCreatable=False}"
             d:DesignHeight="500" d:DesignWidth="800">
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="280" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- =================================================================== -->
        <!-- [é¡¶éƒ¨] å·¥å…·æ  -->
        <!-- =================================================================== -->
        <Border Grid.Row="0" Grid.ColumnSpan="2" Background="#F5F5F5" BorderBrush="#DDDDDD" BorderThickness="0,0,0,1"
                Padding="10,6">
            <StackPanel Orientation="Horizontal">
                <!-- ç»‘å®š Commandï¼Œç»‘å®š IsEnabled -->
                <Button Content="âž• æ–°å»ºè¢«åŠ¨"
                        Command="{Binding CreateCommand}"
                        IsEnabled="{Binding Manager.PassiveRepo.HasData}"
                        Padding="12,5" Margin="0,0,10,0" FontWeight="Bold">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="ToolTip" Value="æ–°å»ºä¸€ä¸ªè¢«åŠ¨èƒ½åŠ›" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Manager.PassiveRepo.HasData}" Value="False">
                                    <Setter Property="ToolTip" Value="[ä¸å¯ç”¨] æœªåŠ è½½æœ‰æ•ˆçš„ Mod æ•°æ®æ–‡ä»¶" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <Button Content="ðŸ—‘ï¸ åˆ é™¤è¢«åŠ¨"
                        Command="{Binding DeleteCommand}"
                        Padding="12,5" Background="#FFE6E6" BorderBrush="#FFCCCC" />
            </StackPanel>
        </Border>

        <!-- =================================================================== -->
        <!-- [å·¦ä¾§] åˆ—è¡¨ -->
        <!-- =================================================================== -->
        <DockPanel Grid.Row="1" Grid.Column="0">
            <!-- æœç´¢æ¡† -->
            <TextBox x:Name="SearchBox"
                     DockPanel.Dock="Top"
                     Margin="5" Padding="5"
                     BorderBrush="#CCC" BorderThickness="1"
                     TextChanged="SearchBox_TextChanged"
                     ToolTip="è¾“å…¥ ID æˆ– åç§° æœç´¢..." />

            <!-- åˆ—è¡¨ -->
            <!-- ã€ä¿®å¤ã€‘åˆ é™¤äº† SelectionChangedï¼Œæ”¹ç”¨ SelectedItem åŒå‘ç»‘å®š -->
            <ListBox x:Name="PassiveListBox"
                     VirtualizingStackPanel.IsVirtualizing="True"
                     VirtualizingStackPanel.VirtualizationMode="Recycling"
                     ItemsSource="{Binding Manager.PassiveRepo.Items}"
                     SelectedItem="{Binding SelectedItem}"
                     DisplayMemberPath="DisplayName"
                     BorderThickness="0,0,1,0" BorderBrush="#DDDDDD" />
        </DockPanel>

        <!-- =================================================================== -->
        <!-- [å³ä¾§] ç¼–è¾‘åŒº -->
        <!-- =================================================================== -->
        <ScrollViewer Grid.Row="1" Grid.Column="1" VerticalScrollBarVisibility="Auto">

            <!-- DataContext åˆ‡æ¢ä¸º SelectedItem (UnifiedPassive) -->
            <StackPanel x:Name="EditPanel" Margin="20" DataContext="{Binding SelectedItem}">

                <!-- æ ·å¼è§¦å‘å™¨ï¼šæŽ§åˆ¶é¢æ¿æ˜¾éšå’Œç¦ç”¨ -->
                <StackPanel.Style>
                    <Style TargetType="StackPanel">
                        <!-- é»˜è®¤æ˜¾ç¤º -->
                        <Setter Property="Visibility" Value="Visible" />
                        <Style.Triggers>
                            <!-- 1. å¦‚æžœæ²¡æœ‰é€‰ä¸­é¡¹ (null)ï¼Œéšè—é¢æ¿ -->
                            <DataTrigger Binding="{Binding}" Value="{x:Null}">
                                <Setter Property="Visibility" Value="Hidden" />
                            </DataTrigger>

                            <!-- 2. å¦‚æžœæ˜¯åŽŸç‰ˆæ•°æ®ï¼Œç¦ç”¨ç¼–è¾‘ -->
                            <DataTrigger Binding="{Binding IsVanilla}" Value="True">
                                <Setter Property="IsEnabled" Value="False" />
                                <Setter Property="Opacity" Value="0.7" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </StackPanel.Style>

                <TextBlock Text="è¢«åŠ¨èƒ½åŠ›ç¼–è¾‘ (Passive)" FontSize="22" FontWeight="Bold" Margin="0,0,0,15" Foreground="#333" />

                <!-- 1. åŸºç¡€å‚æ•°é…ç½® (æ•°æ®æ–‡ä»¶) -->
                <Expander Header="âš™ï¸ åŸºç¡€å‚æ•° (Data)" IsExpanded="True" Margin="0,0,0,15" BorderBrush="#DDD"
                          BorderThickness="1">
                    <StackPanel Margin="10">

                        <!-- ID & Cost -->
                        <Grid Margin="0,0,0,10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="10" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="ID:" FontWeight="Bold" />
                                <TextBox Text="{Binding Id, UpdateSourceTrigger=PropertyChanged}" />
                            </StackPanel>

                            <StackPanel Grid.Column="2">
                                <TextBlock Text="Cost (è´¹ç”¨):" />
                                <TextBox Text="{Binding Cost, UpdateSourceTrigger=PropertyChanged}" />
                            </StackPanel>
                        </Grid>

                        <!-- Rarity & Transfer -->
                        <Grid Margin="0,0,0,10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="10" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Rarity (ç¨€æœ‰åº¦):" />
                                <ComboBox ItemsSource="{x:Static core:GlobalValues.Rarities}"
                                          SelectedItem="{Binding Rarity, UpdateSourceTrigger=PropertyChanged}" />
                            </StackPanel>

                            <StackPanel Grid.Column="2" VerticalAlignment="Bottom">
                                <CheckBox Content="å¯å½’å±ž (CanGivePassive)"
                                          IsChecked="{Binding CanGivePassive, UpdateSourceTrigger=PropertyChanged}"
                                          Margin="0,0,0,5" />
                            </StackPanel>
                        </Grid>
                        <!-- åœ¨ Rarity æˆ–è€…æ˜¯ Cost æ—è¾¹ -->
                        <StackPanel>
                            <TextBlock Text="InnerType (äº’æ–¥ç»„ID):" />
                            <!-- é»˜è®¤æ˜¯ -1ï¼Œä¸ºäº†æ–¹ä¾¿çœ‹ï¼Œå¯ä»¥åŠ ä¸ª ToolTip -->
                            <TextBox Text="{Binding InnerTypeId, UpdateSourceTrigger=PropertyChanged}"
                                     ToolTip="-1 è¡¨ç¤ºæ— é™åˆ¶ï¼›ç›¸åŒæ­£æ•´æ•° ID çš„è¢«åŠ¨ä¸èƒ½åŒæ—¶è£…å¤‡" />
                        </StackPanel>
                        <!-- Script (å†…éƒ¨ç±»å) -->
                        <TextBlock Text="Script (å†…éƒ¨ç±»å):" FontWeight="Bold" />
                        <TextBlock Text="*é€šå¸¸ç•™ç©ºï¼Œé™¤éžä½ æœ‰è‡ªå®šä¹‰C#ä»£ç " FontSize="10" Foreground="Gray" Margin="0,0,0,2" />

                        <!-- ç»‘å®šåˆ° ScriptScanner.PassiveScripts -->
                        <!-- æ³¨æ„ï¼šéœ€è¦ä½¿ç”¨ RelativeSource æ‰¾å›ž UserControl çš„ DataContext (ViewModel) -->
                        <ComboBox IsEditable="True"
                                  Text="{Binding Script, UpdateSourceTrigger=PropertyChanged}"
                                  ItemsSource="{Binding DataContext.Manager.ScriptScanner.PassiveScripts, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                    </StackPanel>
                </Expander>

                <!-- 2. æœ¬åœ°åŒ–æ–‡æœ¬é…ç½® (ç¿»è¯‘æ–‡ä»¶) -->
                <Expander Header="ðŸ“ æœ¬åœ°åŒ–æ–‡æœ¬ (Localization)" IsExpanded="True" Margin="0,0,0,15" BorderBrush="#DDD"
                          BorderThickness="1">
                    <StackPanel Margin="10">

                        <TextBlock Text="Name (è¢«åŠ¨åç§°):" FontWeight="Bold" />
                        <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}" Margin="0,2,0,10" />

                        <TextBlock Text="Desc (æè¿°):" FontWeight="Bold" />
                        <TextBlock Text="*æ”¯æŒæ¢è¡Œ" FontSize="10" Foreground="Gray" />

                        <!-- å¤šè¡Œæ–‡æœ¬æ¡† -->
                        <TextBox Text="{Binding Desc, UpdateSourceTrigger=PropertyChanged}"
                                 Height="100"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 VerticalScrollBarVisibility="Auto"
                                 Margin="0,2,0,0" />
                    </StackPanel>
                </Expander>

                <!-- åº•éƒ¨ç•™ç™½ -->
                <TextBlock Height="50" />

            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>